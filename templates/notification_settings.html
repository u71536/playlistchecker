{% extends "base.html" %}

{% block title %}{{ _('notification_settings.title') }} - PlaylistChecker{% endblock %}

{% block content %}
<style>
    .settings-header {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .settings-card {
        border-radius: 20px;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }
    
    .notification-section {
        padding: 1.5rem;
        border-bottom: 2px solid #f1f5f9;
        transition: all 0.3s ease;
    }
    
    .notification-section:last-child {
        border-bottom: none;
    }
    
    .notification-section:hover {
        background: rgba(99, 102, 241, 0.02);
    }
    
    .section-icon {
        width: 60px;
        height: 60px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
    }
    
    .section-icon i {
        font-size: 1.75rem;
    }
    
    .form-check-input {
        width: 3rem;
        height: 1.5rem;
        border-radius: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .form-check-input:focus {
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        border-color: var(--primary-color);
    }
    
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .info-card {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
        border-radius: 16px;
        padding: 1.5rem;
        border: 2px solid rgba(99, 102, 241, 0.1);
    }
    
    .info-list {
        list-style: none;
        padding: 0;
    }
    
    .info-list li {
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(99, 102, 241, 0.1);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .info-list li:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .info-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
</style>

<div class="settings-header fade-in-up">
    <h1 class="display-6 fw-bold mb-2">
        <i class="fas fa-bell text-primary"></i> {{ _('notification_settings.title') }}
    </h1>
    <p class="text-muted mb-0">Configure how you want to receive playlist change notifications</p>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="settings-card">
            <div class="card-header bg-white border-bottom-0 p-4">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-cog text-primary me-2"></i>{{ _('notification_settings.manage_notifications') }}
                </h5>
            </div>
            <div class="card-body p-0">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <!-- Email Notifications -->
                    <div class="notification-section">
                        <div class="d-flex align-items-start gap-3">
                            <div class="section-icon bg-primary-subtle">
                                <i class="fas fa-envelope text-primary"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-2">{{ _('notification_settings.email_notifications') }}</h6>
                                <p class="text-muted mb-3">{{ _('notification_settings.receive_email_notifications') }}</p>
                                <div class="form-check form-switch mb-3">
                                    {{ form.email_notifications_enabled(class="form-check-input", id="emailNotifications", role="switch") }}
                                    <label class="form-check-label ms-2" for="emailNotifications">
                                        Enable email notifications
                                    </label>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {{ _('notification_settings.notifications_will_be_sent_to') }} <strong>{{ current_user.email }}</strong>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Telegram Notifications -->
                    <div class="notification-section">
                        <div class="d-flex align-items-start gap-3">
                            <div class="section-icon bg-info-subtle">
                                <i class="fab fa-telegram text-info"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-2">{{ _('notification_settings.telegram_notifications') }}</h6>
                                <p class="text-muted mb-3">{{ _('notification_settings.receive_telegram_notifications') }}</p>
                                <div class="form-check form-switch mb-3">
                                    {{ form.telegram_notifications_enabled(class="form-check-input", id="telegramNotifications", role="switch") }}
                                    <label class="form-check-label ms-2" for="telegramNotifications">
                                        Enable Telegram notifications
                                    </label>
                                </div>
                                
                                {% if current_user.telegram_chat_id %}
                                    <div class="status-badge bg-success-subtle text-success">
                                        <i class="fas fa-check-circle"></i>
                                        <span>{{ _('notification_settings.telegram_connected') }}</span>
                                        {% if current_user.telegram_username %}
                                            <span>(@{{ current_user.telegram_username }})</span>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="status-badge bg-warning-subtle text-warning mb-2">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>{{ _('notification_settings.telegram_not_connected') }}</span>
                                    </div>
                                    <a href="{{ url_for('telegram_connect') }}" target="_blank" class="btn btn-info">
                                        <i class="fab fa-telegram me-2"></i>{{ _('notification_settings.connect_telegram') }}
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Browser Notifications -->
                    <div class="notification-section">
                        <div class="d-flex align-items-start gap-3">
                            <div class="section-icon bg-secondary-subtle">
                                <i class="fas fa-desktop text-secondary"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-2">{{ _('notification_settings.browser_notifications') }}</h6>
                                <p class="text-muted mb-3">{{ _('notification_settings.receive_browser_notifications') }}</p>
                                <div class="form-check form-switch mb-3">
                                    {{ form.browser_notifications_enabled(class="form-check-input", id="browserNotifications", role="switch") }}
                                    <label class="form-check-label ms-2" for="browserNotifications">
                                        Enable browser notifications
                                    </label>
                                </div>
                                
                                <div id="pushNotificationStatus" class="mb-2"></div>
                                
                                <button type="button" id="enablePushBtn" class="btn btn-secondary" style="display: none;">
                                    <i class="fas fa-bell me-2"></i>{{ _('notification_settings.allow_notifications') }}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <div class="d-grid">
                            {{ form.submit(class="btn btn-primary btn-lg") }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="info-card mb-4">
            <h6 class="fw-bold mb-3">
                <i class="fas fa-info-circle text-primary me-2"></i>{{ _('notification_settings.notification_types') }}
            </h6>
            <ul class="info-list">
                <li>
                    <div class="info-icon bg-danger-subtle">
                        <i class="fas fa-minus text-danger"></i>
                    </div>
                    <span>{{ _('notification_settings.track_removed') }}</span>
                </li>
                <li>
                    <div class="info-icon bg-success-subtle">
                        <i class="fas fa-plus text-success"></i>
                    </div>
                    <span>{{ _('notification_settings.track_added') }}</span>
                </li>
                <li>
                    <div class="info-icon bg-info-subtle">
                        <i class="fas fa-edit text-info"></i>
                    </div>
                    <span>{{ _('notification_settings.playlist_changes') }}</span>
                </li>
            </ul>
        </div>
        
        <div class="info-card mb-4">
            <h6 class="fw-bold mb-2">
                <i class="fas fa-clock text-primary me-2"></i>{{ _('notification_settings.check_frequency') }}
            </h6>
            <p class="text-muted mb-0">{{ _('notification_settings.every_10_minutes') }}</p>
        </div>
        
        <div class="info-card">
            <h6 class="fw-bold mb-2">
                <i class="fas fa-shield-alt text-primary me-2"></i>{{ _('notification_settings.privacy') }}
            </h6>
            <p class="text-muted small mb-0">
                {{ _('notification_settings.we_do_not_share_your_data') }}
            </p>
        </div>
    </div>
</div>

<!-- JavaScript for push notifications -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const browserNotificationsSwitch = document.getElementById('browserNotifications');
    const pushNotificationStatus = document.getElementById('pushNotificationStatus');
    const enablePushBtn = document.getElementById('enablePushBtn');
    
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        checkPushPermission();
        
        enablePushBtn.addEventListener('click', function() {
            requestPushPermission();
        });
        
        browserNotificationsSwitch.addEventListener('change', function() {
            if (this.checked) {
                checkPushPermission();
            }
        });
    } else {
        pushNotificationStatus.innerHTML = `
            <div class="status-badge bg-warning-subtle text-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <span>{{ _('notification_settings.browser_does_not_support_push_notifications') }}</span>
            </div>
        `;
    }
    
    function checkPushPermission() {
        if (Notification.permission === 'granted') {
            pushNotificationStatus.innerHTML = `
                <div class="status-badge bg-success-subtle text-success">
                    <i class="fas fa-check-circle"></i>
                    <span>{{ _('notification_settings.push_notifications_are_allowed') }}</span>
                </div>
            `;
            enablePushBtn.style.display = 'none';
            registerServiceWorker();
        } else if (Notification.permission === 'denied') {
            pushNotificationStatus.innerHTML = `
                <div class="status-badge bg-danger-subtle text-danger">
                    <i class="fas fa-times-circle"></i>
                    <span>Push notifications blocked</span>
                </div>
            `;
            enablePushBtn.style.display = 'none';
        } else {
            pushNotificationStatus.innerHTML = `
                <div class="status-badge bg-info-subtle text-info">
                    <i class="fas fa-info-circle"></i>
                    <span>{{ _('notification_settings.click_button_to_allow_push_notifications') }}</span>
                </div>
            `;
            enablePushBtn.style.display = 'block';
        }
    }
    
    function requestPushPermission() {
        Notification.requestPermission().then(function(permission) {
            checkPushPermission();
        });
    }
    
    function registerServiceWorker() {
        navigator.serviceWorker.register('/static/sw.js')
            .then(function(registration) {
                console.log('Service Worker registered:', registration);
                return registration.pushManager.getSubscription();
            })
            .then(function(subscription) {
                if (subscription) {
                    console.log('Already subscribed to push notifications');
                    return;
                }
                
                return fetch('/api/push/vapid-public-key')
                    .then(response => response.json())
                    .then(data => {
                        if (data.publicKey) {
                            return subscribeToPush(data.publicKey);
                        }
                    });
            })
            .catch(function(error) {
                console.error('Service Worker registration error:', error);
            });
    }
    
    function subscribeToPush(vapidPublicKey) {
        return navigator.serviceWorker.ready
            .then(function(registration) {
                const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
                
                return registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });
            })
            .then(function(subscription) {
                console.log('Push notification subscription successful:', subscription);
                
                return fetch('/api/push/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        endpoint: subscription.endpoint,
                        keys: {
                            p256dh: arrayBufferToBase64(subscription.getKey('p256dh')),
                            auth: arrayBufferToBase64(subscription.getKey('auth'))
                        }
                    })
                });
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.status === 'success') {
                    console.log('Subscription saved on server');
                }
            })
            .catch(function(error) {
                console.error('Push subscription error:', error);
            });
    }
    
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');
        
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }
    
    function arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }
});
</script>
{% endblock %}