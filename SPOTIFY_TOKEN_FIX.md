# Исправление проблемы с истекшими токенами Spotify

## Описание проблемы
Ошибка `401 - The access token expired` возникала из-за того, что система не автоматически обновляла истекшие токены доступа Spotify.

## Внесенные изменения

### 1. Обновлен `services/spotify_service.py`
- ✅ Добавлен класс исключения `TokenExpiredError` для обработки истекших токенов
- ✅ Обновлены методы `get_user_playlists()`, `get_playlist_tracks()`, `get_playlist_info()` для автоматического обновления токенов
- ✅ Добавлена проверка ошибок 401 и автоматическое обновление через `refresh_access_token()`

### 2. Обновлен `playlist_monitor.py`
- ✅ Модифицирован метод `_get_user_token()` для проверки времени истечения и автоматического обновления токенов
- ✅ Добавлена обработка `TokenExpiredError` в `_check_playlist_impl()`
- ✅ Обновлены вызовы методов сервиса для передачи `refresh_token`
- ✅ Добавлено автоматическое обновление токенов в базе данных при успешном обновлении

### 3. Обновлен `app.py`
- ✅ Добавлена обработка `TokenExpiredError` в роуте `/spotify_playlists`
- ✅ Автоматическое обновление токенов с повторным выполнением запроса
- ✅ Информационные сообщения пользователю об обновлении токенов

## Как это работает

### Автоматическое обновление в мониторе плейлистов
1. При проверке плейлистов система сначала проверяет время истечения токена
2. Если токен истек, автоматически вызывается `refresh_access_token()`
3. Новый токен сохраняется в базе данных
4. Операция продолжается с новым токеном

### Обработка ошибок 401 в сервисах
1. При получении ошибки 401 от Spotify API проверяется наличие `refresh_token`
2. Если `refresh_token` есть, выполняется обновление токена
3. Генерируется исключение `TokenExpiredError` с новыми данными токена
4. Вызывающий код обрабатывает исключение и обновляет токен в БД

### Обновление в веб-интерфейсе
1. При ошибке 401 в веб-роутах токен автоматически обновляется
2. Пользователь видит информационное сообщение об обновлении
3. Запрос повторяется с новым токеном

## Тестирование
Создан скрипт `test_token_refresh.py` для проверки работы обновления токенов:

```bash
python test_token_refresh.py
```

Скрипт тестирует:
- Проверку валидности токенов
- Автоматическое обновление истекших токенов
- Получение плейлистов после обновления
- Работу монитора плейлистов с обновленными токенами

## Результат
- ❌ Ошибка: `401 - The access token expired`
- ✅ Решение: Автоматическое обновление токенов без участия пользователя

Теперь система будет автоматически обновлять токены Spotify при их истечении, что устранит ошибки 401 и обеспечит бесперебойную работу мониторинга плейлистов.
